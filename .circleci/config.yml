version: 2.1

parameters:
  service_name:
    type: string
    default: "go-service-template"
  image:
    type: string
    default: "evrone/go-service-template"

orbs:
  docker: circleci/docker@0.5.20

executors:
  default:
    docker:
      - image: circleci/golang:1.16

aliases:
  - &restore-mod-cache
    keys:
      - go-modules-v1-{{ checksum "go.sum" }}
      - go-modules-v1-

  - &save-mod-cache
    key: go-modules-v1-{{ checksum "go.sum" }}
    paths:
      - "/go/pkg/mod"

jobs:
  linters:
    executor:
      name: default
    steps:
      - checkout
      - run:
          name: Install tools
          command: .circleci/bin/install.sh
      - run:
          name: PATH for working without a relative path
          command: echo "export PATH=$PATH:/home/circleci/project/bin" >> $BASH_ENV
      - run:
          name: Dotenv > Reviewdog
          command: .circleci/bin/reviewdog_dotenv.sh
      - run:
          name: Hadolint > Reviewdog
          command: .circleci/bin/reviewdog_hadolint.sh
      - run:
          name: Golangci-lint > Reviewdog
          command: .circleci/bin/reviewdog_golangci-lint.sh
      - run:
          name: Dotenv
          command: dotenv-linter
      - run:
          name: Hadolint
          command: git ls-files --exclude='Dockerfile*' --ignored | xargs hadolint
      - run:
          name: Golangci-lint
          command: golangci-lint run

  tests:
    executor:
      name: default
    steps:
      - checkout
      - restore_cache: *restore-mod-cache
      - run:
          name: Tests
          command: go test -v -race ./internal/...
      - save_cache: *save-mod-cache

  integration-tests:
    executor:
      name: default
    steps:
      - checkout
      - setup_remote_docker:
          version: 19.03.13
      - run:
          name: Integration tests
          command: docker-compose up --build --abort-on-container-exit --exit-code-from integration

workflows:
  ci:
    jobs:
      - linters
      - tests
      - integration-tests
      # # Build staging image
      # - docker/publish:
      #     context: evrone-erp
      #     image: << pipeline.parameters.image >>
      #     tag: "staging-${CIRCLE_SHA1}"
      #     requires:
      #       - linters
      #       - tests
      #     filters:
      #       branches:
      #         only:
      #           - develop
      # # Build QA image
      # - docker/publish:
      #     context: evrone-erp
      #     image: << pipeline.parameters.image >>
      #     tag: "qa-${CIRCLE_SHA1}"
      #     requires:
      #       - linters
      #       - tests
      #     filters:
      #       branches:
      #         only:
      #           - master
      #           - /release\/v\d.*/
      # # Build production image
      # - docker/publish:
      #     context: evrone-erp
      #     image: << pipeline.parameters.image >>
      #     tag: "$CIRCLE_TAG"
      #     filters:
      #       tags:
      #         only: /^v.*/
      #       branches:
      #         ignore: /.*/
